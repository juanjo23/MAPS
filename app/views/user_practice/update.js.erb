function find_last_element(){
  var last_element = "StartEvent_0gwlf1v";  //Nothing has been added
  var elems = cli.elements();
  for (var i=0; i<elems.length; i++){
    if(elems[i].startsWith("Task")){
      last_element = elems[i];
    }
  }
  return last_element;
}

function add_element(element_name) {
  var last_element = find_last_element();
  var new_element = cli.append(last_element, 'bpmn:Task', '150,0');
  cli.setLabel(new_element, element_name);

/*
  var element = (new_element === undefined)? 'StartEvent_0gwlf1v' : new_element;
  new_element = cli.append(element, 'bpmn:Task', '150,0');
  cli.setLabel(new_element, element_name);
*/
  last_x = cli.element(new_element).x;
  if( last_x >= 999){
    $("#canvas").width((last_x+200)+"px");
    $(".scroll-canvas").scrollLeft(last_x);
  }
}

function save_diagram(){
  bpmnjs.saveXML(function(err, xml){
    $.ajax({
      url: "/user_practice",
      type: "POST",
      data: {xml_diagram: xml},
      success: function(resp){ console.log(resp); }
    });

  });
  console.log("saving diagram");
}


<% practice_name = @current_user_practice.practice.name %>
<% answer = @current_user_practice.answer %>
<% id = @current_user_practice.id %>
<% if UserPractice.exists?(id+1) %>
  <% @current_user_practice = UserPractice.find(id+1)%>
<% else %>
  <% @current_user_practice = nil %>
<% end %>

//Get the next practice
$('#cuestionario').fadeOut(400, function(){
  //Animation complete
  $('#cuestionario').html("<%= escape_javascript(render('cuestionario')) %>");
  $('#cuestionario').fadeIn();
  setRatyStar();
});


//Añadiendo la práctica al diagrama
<% if answer == 3 %>
  add_element("<%= practice_name %>");
<% end %>
//Almacenando el diagrama
save_diagram();
